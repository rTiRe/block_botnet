# Сносер

## 1. Перменные окружения

**`DEVMODE`** - режим разработки. Если `true`, то оплата запускается в сети `TESTNET`. Если `false` или не установлено, то в сети `MAINNET`.

---

**`BOT_TOKEN`** - токен телеграм бота, можно получить через [@BotFather](https://t.me/BotFather). Ниже рассказываю как получить.
<br/>
**`CRYPTO_PAY_TOKEN`** - токен приложения из [@CryptoBot](https://t.me/CryptoBot). Ниже рассказываю как получить.
<br/>
**`API_ID`** - Telegram API ID. Можно получить [здесь](https://my.telegram.org/auth). Ниже рассказываю как получить.
<br/>
**`API_HASH`** - Telegram API Hash. Можно получить [здесь](https://my.telegram.org/auth). Ниже рассказываю как получить.

---

**`FASTAPI_HOST`** - адрес, на который будут отправляться вебхуки. **Оставить пустым**, если они не нужны или не настроен ssl сертификат.
<br/>
**`FASTAPI_PORT`** - порт хоста, на который будут отправляться запросы.
<br/>
**`BOT_WEBHOOK_PATH`** - путь, на который будут отправлять вебхуки телеграм бота. **Не шаришь = не трогай**.
<br/>
**`CRYPTO_WEBHOOK_PATH`** - путь, на который будут отправляться вебхуки от [@CryptoBot](https://t.me/CryptoBot). **Не шаришь = не трогай**.

---

**`POSTGRES_HOST`** - ip, на которром будет запущена Postgres база данных. Лучше оставить `host.docker.internal` если запуск будет проходить через `docker compose`, в противном случае - лучше оставить `0.0.0.0`
<br/>
**`POSTGRES_PORT`** - порт, на которром будет запущена Postgres база данных. Лучше оставить `5432`
<br/>
**`POSTGRES_DB`** - имя Postgres базы данных. **Поставить свое**.
<br/>
**`POSTGRES_USER`** - имя пользователя для подключения к базе данных. **Поставить свое**.
<br/>
**`POSTGRES_PASSWORD`** - пароль для подключения к базе данных. **Поставить свое**.

---

**`REDIS_HOST`** - ip для подключения к Redis базе данных. **Не шаришь?** Просто оставь `redis`.
<br/>
**`REDIS_PORT`** - порт для подключения к Redis базе данных. **Не шаришь?** Просто оставь `6379`.

---

**`SESSIONS_PATH`** - Путь к папке с сессиями `pyrogram` относительно корня проекта. Корень - это тут, где лежит README.

---

**`PROXY_TYPE`** - тип прокси. `http` или `socks4` или `socks5`. Оставить пустым, чтобы не использовать.
<br/>
**`PROXY_LOGIN`** - логин от прокси.
<br/>
**`PROXY_PASSWORD`** - пароль от прокси.
<br/>
**`PROXY_IP`** - ip от прокси.
<br/>
**`PROXY_PORT`** - порт от прокси.

---

**`DEMOLITION_FREEZE_SECONDS`** - Время таймаута между запросами на снос от одного пользователя. В секундах. Оставить пустым или `0`, чтобы отключить.
<br/>
**`LOGS_CHAT_ID`** - id телеграм чата или канала, в который будут отправляться логи.
<br/>
**`MAIN_CHANNEL_URL`** - ссылка на основной канал.
<br/>
**`MAIN_CHANNEL_ID`** - id основного телеграм канала.
<br/>
**`RULES_CHANNEL_URL`** - ссылка на канал с правилами.
<br/>
**`SUPPORT_URL`** - ссылка на аккаунт тех. поддержки.

## 2. Получение токена бота

**1.** Открываем и запускам, если на запущен, [@BotFather](https://t.me/BotFather).
<br/>
**2.** Пишем `/newbot` и создаем нового бота, если еще не создан. Если создан - см. шаг 3. Вводим имя и юзернейм бота, если все прошло успешно, то бот пришлет сообщение со ссылкой на вашего бота и его токеном. Не видно токен? Смотри шаг 3.
<br/>
**3.** Если бот уже существует, то пишем `/mybots`, выбираем нужного бота, после нажимаем на `API Token`.

**API Token** имеет вид `0123456789:abcdefghi-jklmnopqrstuvwxyzabcdefgh`

## 3. Получение API токена приложения [@CryptoBot](https://t.me/CryptoBot) и настройка приложения

**1.** Открываем [@CryptoBot](https://t.me/CryptoBot) и пишем `/start`.
<br/>
**2.** В появившемся меню нажимаем `Crypto Pay`.
<br/>
**3.** Нажимаем `Создать приложение`.
<br/>
**4.** Нажимаем `API-токен` и копируем.
<br/>
**5.** При желании можно нажать `Изменить приложение` и покопаться в настройках.
<br/>
**6.** Для вывода средств с кошелька жмем `Вывести в кошелек`.

**API Token [@CryptoBot](https://t.me/CryptoBot)** имеет вид `123456:abcdefghijklmnopqrstuvwxyzabsdefghi`

Установку вебхуков объяснять пока не буду, она не работает, мне не на чем тестить.

## 4. Получение Telegram API ID и API HASH

**1.** Переходим в [my.telegram.org](https://my.telegram.org/auth) и авторизуемся.
<br/>
**2.** Нажимаем `API Development tools`.
<br/>
**3.** Создаем новое приложение, если оно еще не создано. Туториалы есть в интернете.
<br/>
**4.** Смотрим раздел `App configuration`. Первые 2 строки должны быть `App api_id` - это API ID и `App api_hash` - это API HASH.

**API ID** имеет вид `12345678`
<br>
**API HASH** имеет вид `abcdefghijklmnopqrstuvwxyzabcdef`


## 5. Ультимативныйи гайд по установке

**1.** Загружаем этот проект куда-нибудь на рабочую машину и открываем папку с ним в консоли.
<br/>
**2.** Для начала необходимо настроить переменные окружения. Открываем папку `config`, копируем файл `.env.example`, переименовываем его в `.env` и заполняем, используя разделы _1_, _2_, _3_ и _4_.
<br/>
**3.** На этом можно закончить, но если охота настроить сообщения бота и текста его кнопок, то это будет описано в разделах _6_ и _7_.
<br/>
**4.** Запуск бота осущесвляется при помощи команд, написаных ниже. Если внутри `.env` файла был изменен, то необходимо пересобирать бота (_ЕСЛИ ИЗМЕНЕНЫ НАСТРОЙКИ POSTGRES, ТО ВСЕ ДАННЫЕ ИЗ БАЗЫ ДАННЫХ В ТАКОМ СЛУЧАЕ БУДУТ УДАЛЕНЫ!_). Если вы что-то в текстах кнопок, то необходимо перезапустить бота.

**Запустить:**
```
sudo docker compose --env-file ./config/.env up
```

**Запуск с предварительной сборкой:**
```
sudo docker compose --env-file ./config/.env up --build
```

**Запуск в detached режиме, чтобы консоль не мельтешила:**
```
sudo docker compose --env-file ./config/.env up -d
```

**Перезапустить:**
```
sudo docker compose --env-file ./config reload
```

**Завершить работу:**
```
sudo docker compose --env-file ./config/.env down
```

## 6. Изменение сообщений бота

Для вывода сообщений в боте испоьлзуется система `jinja2`, почитать о ней можно в интеренете. В кратце: она позволяет вставлять в текст переменные, условия и циклы.

Все сообщения боты находятся внутри папки `src/templates` и имеют расширение `.jinja2`.

Ниже описаны все используемые шаблоны: название, для чего используется и какие переменные в него поступают.

**`start.jinja2`** - сообщение, которое отправляет бот после получения команды `/start`
<br/>
**`main.jinja2`** - заголовок главного меню.
<br/>
**`profile.jinja2`** - отображение профиля пользователя.
 + `user` - объект телеграм пользователя.
 + `subscription` - строка с оставшемся времени подписки или None, если подписка отсутствует или ее срок истек.

**`select_subscription.jinja2`** - заголовок меню выбора подписки.
<br/>
**`pay.jinja2`** - описание чека на оплату
 + `invoice` - объект чека CryptoBot.

**`prepare_demolition.jinja2`** - сообщение об ожидании ссылки на сообщение.
<br/>
**`without_subscription.jinja2`** - сообщение об отсутствии подписки у пользователя.
<br/>
**`demolition_freezed.jinja2`** - Сообщение о таймауте между запросами на снос.
 + `time` - время в секундах до следующего запроса.

**`incorrect_link.jinja2`** - сообщение о некорректной ссылке на сообщение.
 + `link` - ссылка, отправленная пользователем.

**`success_link.jinja2`** - сообщение о начале отправке жалоб на сообщение после получения корректной ссылки.
 + `link` - ссылка, отправленная пользователем.

**`demolition_end.jinja2`** - сообщение об окончании отправки жалоб на сообщение.
 + `link` - ссылка, отправленная пользователем.
 + `success` - количество успешных репортов.
 + `fail` - количество неудачных репортов.
 + `time` - время в секундах до следующего запроса.

**`log_message.jinja2`** - сообщение лога, отправляемое в указанную группу или канал.
 + `user` - объект телеграм пользователя.
 + `link` - ссылка, отправленная пользователем.
 + `success` - количество успешных репортов.
 + `fail` - количество неудачных репортов.

## 7. Изменение текста кнопок

Все текста кнопок хранятся внутри файлов папки `src/templates/keyboard_buttons`.

**Текст кнопок писать необходимо внутри одинарных кавычек!**

Ниже перечислены все переменные, определяющие текста кнопок:

**`call.py`**:
 + `CALL_MAIN_MENU` - кнопка вызова главного меню.

**`main.py`**:
 + `START_DEMOLITION` - кнопка начала сноса.
 + `PROFILE` - кнопка перехода в профиль.
 + `SUPPORT` - кнопка для перехода в чат с поддержкой.

**`channel.py`**:
 + `MAIN_CHANNEL` - кнопка открытия основного канала.
 + `RULES_CHANNEL` - кнопка открытия канала с правилами.
 + `CHECK_SUBSCRIPTION` - кнопкапроверки подписки на основной канал.

**`demolition.py`**:
 + `CANCEL_DEMOLITION` - кнопка выхода из меню сноса.

**`return_back.py`**:
 + `RETURN_BACK` - кнопка возвращаения на предыдущую страницу меню.

## 8. Изменение сроков подписки

Все данные о подписках лежат внутри файла `src/templates/keyboard_buttons/subscription.py`.

Ниже представлена вся информация о том, как хранятся данные о подписках.

Внутри переменной `SUBSCRIPTIONS` лежат все объекты подписок в следующем формате:

```python
SUBSCRIPTIONS = MappingProxyType(
    {
        'subscription_name_1': subscription_object_1,
        'subscription_name_2': subscription_object_2,
        'subscription_name_3': subscription_object_3,
    },
)
```

Как выглядит объект подписки **`subscription_object`**:

```python
{
    'name': 'Строка',
    'duration': 7,
    'invoice': {
        'amount': 7,
        'description': 'Строка',
        'currency_type': 'Строка'
        'asset': 'Строка',
        'hidden_message': 'Строка',
        'paid_btn_name': 'Строка',
        **invoice_const_data,
    },
}
```

Некоторые из полей, как можно заметить, присутствуют внутри переменной `invoice_const_data`, но внутри самого объекта подписки их нет. Это нормально - это те поля, которые не меняются ни в одном чеке. Вы можете спокойно выносить поля из `invoice_const_data` в объект подписки, главное чтобы их не было одновременно и там и там.

Теперь расскажу что за что отвечает:

**`name`** - это имя подписки, оно же будет отображаться на кнопках при выборе подписки.
<br/>
**`duration`** - продолжительность подписки в днях.
<br/>
**`description`** - текст, отображающийся перед оплатой.
<br/>
**`hidden_message`** - текст, отображающийся после оплаты.
<br/>
**`paid_btn_name`** - что будет делать кнопка после успешной оплаты. Может быть одним из списка ниже. В зависимости от выбранного меняется текст кнопки:
 + `openBot`
 + `viewItem`
 + `openChannel`
 + `callback`

**`paid_btn_url`** - ссылка, на которую будет вести кнопка после оплаты.
<br/>
**`currency_type`** - тип валюты, в которой будет производится оплата.
<br/>
**`asset`** - криптовалюта, в которой будет производится оплата.
<br/>
**`amount`** - количество валюты для оплаты.

**Лучше не трогать `currency_type` и `asset`, так как нормально объяснить как это работает я не смогу. Нужно поменять - пиши мне**
